# Part of the implementation of this container is based on the Amazon SageMaker Apache MXNet container.
# https://github.com/aws/sagemaker-mxnet-container

FROM nvidia/cuda:12.1.1-base-ubuntu22.04

LABEL maintainer="NASA IMPACT"

ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get update && \
    apt-get install -y software-properties-common && \
    add-apt-repository -y ppa:deadsnakes/ppa && \
    apt-get update

RUN apt-get update && apt-get install -y libgl1 python3-pip python3-dev git libgdal-dev --fix-missing

RUN rm -rf /var/lib/apt/lists/*

WORKDIR /

RUN pip3 install --upgrade pip

# RUN pip3 install GDAL

COPY requirements-inference.txt requirements.txt

RUN pip3 install -r requirements.txt --ignore-installed

ENV CUDA_HOME=/usr/local/cuda

RUN mkdir models

# Copies code under /opt/ml/code where sagemaker-containers expects to find the script to run
COPY code /opt/program

ENV PYTHONUNBUFFERED=TRUE
ENV PYTHONDONTWRITEBYTECODE=TRUE
ENV PATH="/opt/program:${PATH}"



# Copies code under /opt/ml/code where sagemaker-containers expects to find the script to run
WORKDIR /opt/program

COPY main.py /app

EXPOSE 8080

CMD ["uvicorn", "predictor:app", "--host", "0.0.0.0", "--port", "8080"]

